<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quantiva ‚Äî Account</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body data-page="account">
    <!-- HEADER -->
    <header class="header" data-header>
      <div class="container header__inner">
        <a class="brand" href="index.html#top" aria-label="Quantiva">
          <span class="brand__mark" aria-hidden="true">
            <img class="brand__logo" src="assets/logo.svg" alt="" />
          </span>
          <span class="brand__name">Quantiva</span>
        </a>
        <nav class="nav" aria-label="Navigation">
          <a class="nav__link" href="index.html#features" data-i18n="nav.features">Features</a>
          <a class="nav__link" href="index.html#security" data-i18n="nav.security">Security</a>
          <a class="nav__link" href="index.html#pricing" data-i18n="nav.pricing">Pricing</a>
          <a class="nav__link" href="index.html#faq" data-i18n="nav.faq">FAQ</a>
        </nav>
        <div class="header__actions">
          <div class="header__btns">
            <!-- –Ω–∞ account —Å—Ç—Ä–∞–Ω–∏—Ü–µ —ç—Ç–æ –±—É–¥–µ—Ç Sign out -->
            <button class="btn btn--ghost" type="button" id="signOutBtn" data-i18n="nav.signout">
              Sign out
            </button>
            <a class="btn btn--primary" href="account.html" data-i18n="nav.account">Account</a>
          </div>
          <button class="iconbtn burger" type="button" aria-label="Open menu" data-burger>
            <span class="burger__line"></span>
            <span class="burger__line"></span>
            <span class="burger__line"></span>
          </button>
        </div>
      </div>
      <!-- Mobile nav -->
      <div class="mobile-nav" data-mobile-nav>
        <a class="mobile-nav__link" href="index.html#features" data-i18n="nav.features">Features</a>
        <a class="mobile-nav__link" href="index.html#security" data-i18n="nav.security">Security</a>
        <a class="mobile-nav__link" href="index.html#pricing" data-i18n="nav.pricing">Pricing</a>
        <a class="mobile-nav__link" href="index.html#faq" data-i18n="nav.faq">FAQ</a>
        <div class="mobile-nav__actions">
          <button class="btn btn--ghost w100" type="button" id="signOutBtnMobile" data-i18n="nav.signout">
            Sign out
          </button>
          <a class="btn btn--primary w100" href="account.html" data-i18n="nav.account">Account</a>
        </div>
      </div>
    </header>

    <main class="account">
      <div class="container account__grid">
        <!-- SIDEBAR -->
        <aside class="sidebar" aria-label="Account navigation">
          <div class="sidebar__title" data-i18n="account.sidebar.title">Workspace</div>
          <a class="sidebar__link is-active" href="#dash" data-i18n="account.nav.dashboard">Dashboard</a>
          <a class="sidebar__link" href="#settings" data-i18n="account.nav.settings">Account settings</a>
          <a class="sidebar__link" href="#subs" data-i18n="account.nav.subs">Manage subscriptions</a>
          <a class="sidebar__link" href="#billing" data-i18n="account.nav.billing">Billing</a>
          <a class="sidebar__link" href="#security" data-i18n="account.nav.security">Security</a>
          <div class="sidebar__divider"></div>
          <a class="sidebar__link" href="index.html#top" data-i18n="account.nav.back">‚Üê Back to landing</a>
        </aside>

        <!-- CONTENT -->
        <section class="account__content">
          <div class="account__head">
            <h1 class="account__h1" data-i18n="account.title">Account</h1>
            <p class="account__sub" data-i18n="account.subtitle">
              Your dashboard, settings, and subscription in one place.
            </p>
          </div>

          <!-- DASHBOARD -->
          <div id="dash" class="account__cards">
            <article class="a-card">
              <div class="a-card__label" data-i18n="account.card.plan.label">Plan</div>
              <div class="a-card__value" id="planValue" data-i18n="account.card.plan.value">Free</div>
              <div class="a-card__hint" data-i18n="account.card.plan.hint">Upgrade anytime.</div>
            </article>
            <article class="a-card">
              <div class="a-card__label" data-i18n="account.card.status.label">Status</div>
              <div class="a-card__value" id="statusValue" data-i18n="account.card.status.value">Active</div>
              <div class="a-card__hint" data-i18n="account.card.status.hint">Signed in with Supabase.</div>
            </article>
            <article class="a-card a-card--wide">
              <div class="a-card__label" data-i18n="account.card.email.label">Email</div>
              <div class="a-card__value" id="userEmail">
                <span data-account-email>‚Äî</span>
              </div>
              <div class="a-card__hint" data-i18n="account.card.email.hint">This is your login email.</div>
            </article>
          </div>

          <!-- SECTIONS -->
          <div class="a-section" id="settings">
            <div class="a-section__title" data-i18n="account.settings.title">Account settings</div>
            <div class="a-panel">
              <p class="a-text" data-i18n="account.settings.text">Update your profile preferences.</p>

              <!-- ‚úÖ real settings form -->
              <form class="form" id="profileForm" autocomplete="off">
                <label class="field">
                  <span data-i18n="account.settings.name">Display name</span>
                  <input name="full_name" type="text" placeholder="Your name" />
                </label>
                <label class="field">
                  <span data-i18n="account.settings.currency">Currency</span>
                  <input name="currency" type="text" placeholder="EUR" />
                </label>
                <label class="field">
                  <span data-i18n="account.settings.timezone">Timezone</span>
                  <input name="timezone" type="text" placeholder="Europe/Berlin" />
                </label>
                <button class="btn btn--primary btn--sm" type="submit" id="saveProfileBtn">Save changes</button>
                <p class="form__hint muted">
                  Saved to Supabase: <span class="muted">public.profiles</span>
                </p>
              </form>
            </div>
          </div>

          <div class="a-section" id="subs">
            <div class="a-section__title" data-i18n="account.subs.title">Manage subscriptions</div>
            <div class="a-panel">
              <p class="a-text" data-i18n="account.subs.text">
                Choose a plan. (Stripe connection can be added later.)
              </p>
              <div class="a-actions">
                <!-- ‚úÖ enabled + opens modal -->
                <button
                  class="btn btn--primary btn--sm"
                  type="button"
                  id="upgradePlanBtn"
                  data-open="plans"
                  data-i18n="account.subs.upgrade"
                >
                  Upgrade plan
                </button>
                <!-- keep, but still disabled until Stripe -->
                <button class="btn btn--ghost btn--sm" type="button" disabled data-i18n="account.subs.cancel">
                  Cancel subscription
                </button>
              </div>
            </div>
          </div>

          <div class="a-section" id="billing">
            <div class="a-section__title" data-i18n="account.billing.title">Billing</div>
            <div class="a-panel">
              <p class="a-text" data-i18n="account.billing.text">
                Invoices, payment methods, and billing history will appear here.
              </p>
            </div>
          </div>

          <div class="a-section" id="security">
            <div class="a-section__title" data-i18n="account.security.title">Security</div>
            <div class="a-panel">
              <p class="a-text" data-i18n="account.security.text">Change your password or reset it via email.</p>

              <!-- ‚úÖ Change password (requires old password via re-login) -->
              <form class="form" id="changePasswordForm" autocomplete="off">
                <label class="field">
                  <span>Current password</span>
                  <input name="current_password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                </label>
                <label class="field">
                  <span>New password</span>
                  <input name="new_password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                </label>
                <label class="field">
                  <span>Repeat new password</span>
                  <input name="new_password_repeat" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                </label>
                <div class="a-actions">
                  <button class="btn btn--primary btn--sm" type="submit" id="changePassBtn">Change password</button>
                  <button class="btn btn--ghost btn--sm" type="button" id="resetPasswordBtn">Send reset link</button>
                </div>
              </form>

              <p class="form__hint muted">‚ÄúSend reset link‚Äù –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–∏—Å—å–º–æ –Ω–∞ —Ç–≤–æ–π email (Supabase reset).</p>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- ‚úÖ Plans modal -->
    <div class="modal" data-modal="plans" aria-hidden="true">
      <div class="modal__backdrop" data-close></div>
      <div class="modal__card" role="dialog" aria-modal="true" aria-label="Choose plan">
        <div class="modal__head">
          <h3 class="modal__title">Choose your plan</h3>
          <button class="iconbtn" type="button" data-close aria-label="Close">‚úï</button>
        </div>
        <div class="form" id="plansList">
          <button class="btn btn--ghost w100" type="button" data-plan="free">Free ‚Äî ‚Ç¨0</button>
          <button class="btn btn--ghost w100" type="button" data-plan="student">Student ‚Äî ‚Ç¨2.99 / mo</button>
          <button class="btn btn--ghost w100" type="button" data-plan="family">Family ‚Äî ‚Ç¨11.99 / mo</button>
          <button class="btn btn--ghost w100" type="button" data-plan="business">Business ‚Äî ‚Ç¨29.99 / mo</button>
          <p class="form__hint muted">–°–µ–π—á–∞—Å —ç—Ç–æ ‚Äúmanual plan‚Äù –≤ Supabase (Stripe –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ).</p>
        </div>
      </div>
    </div>

    <!-- Floating language (bottom-right) -->
    <div class="lang-float" data-lang-float>
      <button class="lang-float__btn" type="button" data-lang-btn aria-label="Language">
        <span data-lang-label>EN</span> ¬∑ üåê
      </button>
      <div class="lang-float__menu" data-lang-menu>
        <button type="button" class="lang-float__item" data-set-lang="en">English</button>
        <button type="button" class="lang-float__item" data-set-lang="de">Deutsch</button>
        <button type="button" class="lang-float__item" data-set-lang="ru">–†—É—Å—Å–∫–∏–π</button>
      </div>
    </div>

    <div class="toast" aria-live="polite" aria-atomic="true" id="toast"></div>

    <!-- ‚úÖ SUPABASE SDK (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–ï–†–ï–î app.js) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js"></script>

    <!-- ‚úÖ Account page wiring (email, profile, plans, security) -->
    <script>
      (function () {
        "use strict";

        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const toast = $("#toast");
        let toastTimer = null;
        function showToast(msg) {
          if (!toast) return;
          toast.textContent = msg;
          toast.style.display = "block";
          clearTimeout(toastTimer);
          toastTimer = window.setTimeout(() => {
            toast.style.display = "none";
          }, 2600);
        }

        async function getUserSafe() {
          if (!window.sb) return null;
          try {
            const { data, error } = await window.sb.auth.getUser();
            if (error) return null;
            return data?.user || null;
          } catch {
            return null;
          }
        }

        async function requireAuthOrRedirect() {
          const user = await getUserSafe();
          if (!user) {
            // –Ω–µ—Ç —Å–µ—Å—Å–∏–∏ ‚Äî –Ω–∞–∑–∞–¥ –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥
            window.location.href = "index.html#top";
            return null;
          }
          return user;
        }

        function setEmail(email) {
          const el = document.querySelector("[data-account-email]");
          if (el) el.textContent = email || "‚Äî";
        }

        function setPlanLabel(planId) {
          const planEl = $("#planValue");
          if (!planEl) return;
          const map = {
            free: "Free",
            student: "Student",
            family: "Family",
            business: "Business",
          };
          planEl.textContent = map[String(planId || "free").toLowerCase()] || "Free";
        }

        async function loadSubscription(userId) {
          // –æ–∂–∏–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É public.user_subscriptions: user_id (pk), plan_id, status
          if (!window.sb) return;
          try {
            const { data, error } = await window.sb
              .from("user_subscriptions")
              .select("plan_id,status")
              .eq("user_id", userId)
              .maybeSingle();

            if (error) {
              // –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã/rls –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–∏–º Free
              return;
            }
            if (data?.plan_id) setPlanLabel(data.plan_id);
            const statusEl = $("#statusValue");
            if (statusEl && data?.status) statusEl.textContent = String(data.status).charAt(0).toUpperCase() + String(data.status).slice(1);
          } catch {
            // ignore
          }
        }

        async function loadProfile(userId) {
          // –æ–∂–∏–¥–∞–µ–º public.profiles: id uuid pk, full_name, currency, timezone
          if (!window.sb) return;
          const form = $("#profileForm");
          if (!form) return;

          try {
            const { data, error } = await window.sb
              .from("profiles")
              .select("full_name,currency,timezone")
              .eq("id", userId)
              .maybeSingle();

            if (error) return;

            if (data?.full_name) form.full_name.value = data.full_name;
            if (data?.currency) form.currency.value = data.currency;
            if (data?.timezone) form.timezone.value = data.timezone;
          } catch {
            // ignore
          }
        }

        function wireSignOut() {
          const btn1 = $("#signOutBtn");
          const btn2 = $("#signOutBtnMobile");
          [btn1, btn2].filter(Boolean).forEach((btn) => {
            btn.addEventListener("click", async () => {
              if (!window.sb) return;
              try {
                const { error } = await window.sb.auth.signOut();
                if (error) return showToast(error.message || "Sign out failed.");
                showToast("Signed out.");
                window.location.href = "index.html#top";
              } catch {
                showToast("Sign out failed.");
              }
            });
          });
        }

        function wireProfileSave(userId) {
          const form = $("#profileForm");
          if (!form) return;

          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!window.sb) return showToast("Supabase not ready.");

            const payload = {
              id: userId,
              full_name: String(form.full_name.value || "").trim() || null,
              currency: String(form.currency.value || "").trim() || null,
              timezone: String(form.timezone.value || "").trim() || null,
              updated_at: new Date().toISOString(),
            };

            try {
              const { error } = await window.sb.from("profiles").upsert(payload, { onConflict: "id" });
              if (error) return showToast(error.message || "Save failed.");
              showToast("Saved.");
            } catch {
              showToast("Save failed.");
            }
          });
        }

        function wirePlans(userId) {
          const list = $("#plansList");
          if (!list) return;

          list.addEventListener("click", async (e) => {
            const btn = e.target.closest("[data-plan]");
            if (!btn) return;
            const plan = btn.getAttribute("data-plan");
            if (!plan) return;

            if (!window.sb) return showToast("Supabase not ready.");

            try {
              const { error } = await window.sb.from("user_subscriptions").upsert(
                {
                  user_id: userId,
                  plan_id: plan,
                  status: "active",
                  updated_at: new Date().toISOString(),
                },
                { onConflict: "user_id" }
              );

              if (error) return showToast(error.message || "Plan update failed.");
              setPlanLabel(plan);
              showToast("Plan updated.");
              // –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å —Ç–≤–æ–∏–º app.js: data-close –Ω–∞ backdrop/btn)
              const openModal = document.querySelector('[data-modal="plans"]');
              if (openModal) openModal.classList.remove("is-open");
              document.documentElement.style.overflow = "";
            } catch {
              showToast("Plan update failed.");
            }
          });
        }

        function wireSecurity(userEmail) {
          const resetBtn = $("#resetPasswordBtn");
          const form = $("#changePasswordForm");
          if (resetBtn) {
            resetBtn.addEventListener("click", async () => {
              if (!window.sb) return showToast("Supabase not ready.");
              if (!userEmail) return showToast("Email not found.");
              try {
                const { error } = await window.sb.auth.resetPasswordForEmail(userEmail, {
                  // –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –ø–æ –ø–∏—Å—å–º—É –º–æ–∂–Ω–æ –≤–µ—Å—Ç–∏ –Ω–∞ account.html (–∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É reset)
                  redirectTo: window.location.origin + window.location.pathname.replace(/\/[^/]*$/, "/") + "account.html",
                });
                if (error) return showToast(error.message || "Reset failed.");
                showToast("Reset link sent.");
              } catch {
                showToast("Reset failed.");
              }
            });
          }

          if (form) {
            form.addEventListener("submit", async (e) => {
              e.preventDefault();
              if (!window.sb) return showToast("Supabase not ready.");
              if (!userEmail) return showToast("Email not found.");

              const fd = new FormData(form);
              const currentPass = String(fd.get("current_password") || "");
              const newPass = String(fd.get("new_password") || "");
              const newPass2 = String(fd.get("new_password_repeat") || "");

              if (!currentPass || !newPass || !newPass2) return showToast("Please fill all fields.");
              if (newPass.length < 6) return showToast("New password must be at least 6 characters.");
              if (newPass !== newPass2) return showToast("New passwords do not match.");

              try {
                // re-login to prove ‚Äúold password‚Äù
                const { error: signInErr } = await window.sb.auth.signInWithPassword({
                  email: userEmail,
                  password: currentPass,
                });
                if (signInErr) return showToast("Current password is incorrect.");

                const { error: updErr } = await window.sb.auth.updateUser({ password: newPass });
                if (updErr) return showToast(updErr.message || "Password change failed.");

                form.reset();
                showToast("Password changed.");
              } catch {
                showToast("Password change failed.");
              }
            });
          }
        }

        async function init() {
          // –∂–¥—ë–º, –ø–æ–∫–∞ app.js —Å–æ–∑–¥–∞—Å—Ç window.sb
          if (!window.sb) {
            console.warn("Supabase client not found on window.sb. Check script order.");
          }

          const user = await requireAuthOrRedirect();
          if (!user) return;

          const email = user.email || "";
          setEmail(email);
          wireSignOut();

          await loadProfile(user.id);
          wireProfileSave(user.id);

          await loadSubscription(user.id);
          wirePlans(user.id);

          wireSecurity(email);
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init);
        } else {
          init();
        }
      })();
    </script>
  </body>
</html>
